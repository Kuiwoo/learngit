<!DOCTYPE html>
<!--[if IE 9 ]><html class="ie9"><![endif]-->
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
        <meta name="format-detection" content="telephone=no">
        <meta charset="UTF-8">

        <meta name="description" content="Violate Responsive Admin Template">
        <meta name="keywords" content="Super Admin, Admin, Template, Bootstrap">

        <title>write</title>
            
        <!-- CSS -->
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/animate.min.css" rel="stylesheet">
        <link href="css/font-awesome.min.css" rel="stylesheet">
        <link href="css/form.css" rel="stylesheet">
        <link href="css/calendar.css" rel="stylesheet">
        <link href="css/media-player.css" rel="stylesheet">
        <link href="css/style-write.css" rel="stylesheet">
        <link href="css/icons.css" rel="stylesheet">
        <link href="css/generics.css" rel="stylesheet"> 
        <style type="text/css">
        	.addSome{
        		color: #33BE40!important;
        		display: none;
        	}
        </style>
    </head>
    <body id="skin-blur-violate">

        
     
        
        <section id="main" class="p-relative" role="main">
            
       
            <section id="content" class="container">
            
           
   
              <a href="blog.html">  <h4 class="page-title">返回</h4></a>
                                
                <div class="block-area">
                    <div class="row m-container">
                        

                        <div class="col-xs-1 col-md-1 col-sm-0"></div>
                        <div class="col-xs-10 col-md-10 col-sm-12">
                            


                            <!-- Quick Posting -->
                            <div class="tile">
                                <h2 class="tile-title">write</h2>
                                <!--div class="tile-config dropdown">
                                    <a data-toggle="dropdown" href="" class="tooltips tile-menu" title="" data-original-title="Options"></a>
                                    <ul class="dropdown-menu pull-right text-right">
                                        <li><a href="">Edit</a></li>
                                        <li><a href="">Delete</a></li>
                                    </ul>
                                </div-->
                                
                                <div role="form" class="p-15">
                                    <div class="form-group m-b-15">
                                        <label>标题</label>
                                        <input type="text" id="title" class="form-control input-sm">
                                    </div>
                                    
                                    <div class="form-group m-b-15 col-xs-4">
                                        <label>分类</label>
                                        <select class="select" id="type1">
                                          
                                        </select>
                                    </div>
                                    <div class="form-group m-b-15 col-xs-4">
                                        <label>次级分类</label>
                                        <select class="select" id="type2">
                                     
                                        </select>
                                    </div>
                                    <div class="form-group m-b-15 col-xs-4">
                                        <label>小分类</label>
                                        <select class="select" id="type3">
                                 
                                        </select>
                                    </div>
                                    
                                    <div class="form-group m-b-15" style="margin-top: 70px;">
                                        <label></label>
                                        <div class="wysiwye-editor"></div>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-sm" id="write-done" onclick="writeDone();">Submit</button>
                                    <button type="submit" class="btn btn-sm" id="write-clear">Clear</button>
                                    
                                </div>
                            </div>
                        </div>
                        <div class="clearfix"></div>
                    </div>
                </div>
            </section>
        </section>
        
        <!--
        	作者：410232436@qq.com
        	时间：2016-09-29
        	描述：新增类型拟态框
        -->
        	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content">
			            <div class="modal-header">
			                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			                <h4 class="modal-title" id="myModalLabel">添加分类</h4>
			            </div>
			            <div class="modal-body">父级分类：<span id="parent-text">默认</span></div>
			            <div class="form-group">
			            <input type="text"  class="form-control" id="newTypeText" parent="" placeholder="请输入名称"/>
			             </div>
			            <div class="modal-footer">
			                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
			                <button type="button" class="btn btn-success" data-dismiss="modal" onclick="addType();" style="background-color: green;">添加</button>
			            </div>
			        </div><!-- /.modal-content -->
			    </div><!-- /.modal -->
			</div>
			
		<div class="modal fade" id="success" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content">
			            <div class="modal-header">
			                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			                <h4 class="modal-title" id="myModalLabel">完成</h4>
			            </div>
			    		<div class="modal-body">添加成功。</div>
			            <div class="modal-footer">
			                
			                <button type="button" class="btn btn-success" data-dismiss="modal" onclick="location.href='blog.html'" style="background-color: green;">确定</button>
			            </div>
			        </div><!-- /.modal-content -->
			    </div><!-- /.modal -->
			</div>	
			
			
			
			<div class="modal fade" id="faild" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			    <div class="modal-dialog">
			        <div class="modal-content">
			            <div class="modal-header">
			                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			                <h4 class="modal-title" id="myModalLabel">完成</h4>
			            </div>
			    		<div class="modal-body">添加失败，请重试。</div>
			            <div class="modal-footer">
			                
			                <button type="button" class="btn btn-success" data-dismiss="modal" onclick="" style="background-color: #AC1C00 ;">确定</button>
			            </div>
			        </div><!-- /.modal-content -->
			    </div><!-- /.modal -->
			</div>	
        <!-- Javascript Libraries -->
        <!-- jQuery -->
        <script src="js/jquery.min.js"></script> <!-- jQuery Library -->
        <script src="js/jquery-ui.min.js"></script> <!-- jQuery UI -->

        <!-- Bootstrap -->
        <script src="js/bootstrap.min.js"></script>
        
      
        <!-- Text Editor -->
        <script src="js/editor.min.js"></script> <!-- WYSIWYG Editor -->
        

        <!-- UX -->
        <script src="js/scroll.min.js"></script> <!-- Custom Scrollbar -->
        
        <!-- Other -->
        <script src="js/calendar.min.js"></script> <!-- Calendar -->
        <script src="js/feeds.min.js"></script> <!-- News Feeds -->
        
        
        <!-- All JS functions -->
        <script src="js/functions.js"></script>
        
        <script type="text/javascript">
        typeList={};
        typeData=null;
        	$(function(){
        		getTypeList();
        	});
        
          
            
            $(function(){
            	$('.note-editable').css('height','400px');
            	
            });
            
            function getTypeList(){
            	$.ajax({
					url: 'http://localhost/index.php?app=user&act=typeList',
					type: 'GET',
					success: function(result) {
						if(result && result.retval!=false){
							var data=result.retval;
							typeData=data;
								setMust('#type1',true);
								setMust('#type2',false);
								setMust('#type3',false);
								for(var i in data[0]){
									
									$('#type1').append('<option value="'+data[0][i].id+'">'+data[0][i].title+'</option>');
									typeList[data[0][i].title]=data[0][i].id;
								}
							
						if($('.select')[0]) {
						    $('.select').selectpicker();
						}
						}else{
						alert('获取数据出错');
        			return false;
						}
						}
					});
            	
            }
            $('.select').change(function(){
            	var selected=$(this).find("option:selected").text();
            	var selectId=$(this).attr('id');
            	var id=selectId.replace('type','');
            	var thisVal=$(this).find("option:selected").val();
            	if(thisVal=="addType"){
            		var parentText=id>1?$('#type'+(parseInt(id)-1)).find("option:selected").text():'';
            		var parentId=id>1?$('#type'+(parseInt(id)-1)).find("option:selected").val():'';
            		$('#parent-text').text(parentText);
            		$('#newTypeText').attr('parent',parentId);
            		$('#myModal').modal('show');
            		
            	}
            	
            	if(id<3){
            		var parentId=typeList[selected];
            		var chaildList=typeData[parentId];
            		var nextType='#type'+(parseInt(id)+1);
            		$(nextType).html('');
            	
            		if(thisVal=='norm' || thisVal=='addType' ){
            			setMust(nextType,false);
            		}else{
            			setMust(nextType,true);
		            		for(var i in typeData[id]){
		            			console.log(typeData[id][i]);
		            			console.log(parentId);
		            			if(typeData[id][i].parentId==parentId){
		            				$(nextType).append('<option value="'+typeData[id][i].id+'">'+typeData[id][i].title+'</option>');
		            				typeList[typeData[id][i].title]=typeData[id][i].id;
		            			}
		            		}
            		}
            		$(nextType).selectpicker('refresh');
            		$(nextType).selectpicker('val','norm');
            	}
            	
            });
            
            function addType(){
            	var newType=$('#newTypeText').val();
            	var parent=$('#newTypeText').attr('parent');
            	if(newType.length==0){
            		return false;
            	}
            	$.ajax({
					url: 'http://localhost/index.php?app=user&act=typeList',
					type: 'POST',
					data: {type:newType,parentId:parent},
					success: function(result) {
						if(result && result.retval!=false){
							var data=result.retval;
							typeData[data.indexs]=data;
							var nextType='#type'+(parseInt(data.indexs)+1);
							$(nextType).append('<option value="'+data.Id+'">'+data.title+'</option>');
							$(nextType).selectpicker('refresh');
            				$(nextType).selectpicker('val',data.Id);
						}else{
						alert('获取数据出错');
        			return false;
						}
						}
					});
            	$('#addType3').before('<option value="" class="select-index- selectone">'+$('#newTypeText').val()+'</option>');
            	$('.select').selectpicker('refresh');
            }
            
            function setMust(BigType,addType){
            	var norm="<option value='norm'>普通（无）</option>";
                var add="<option class='addSome' value='addType' >新增分类</option>"; 
                addType?$(BigType).append(norm+add):$(BigType).append(norm);
                return true;
            }
            
            function writeDone(){
            	var titile1=$('#title').val();
            	var types=[$('#type1').find("option:selected").val(),$('#type2').find("option:selected").val(),$('#type3').find("option:selected").val()];
           		var length=2;
           		while(types[length]=='addType' || types[length]=='norm'){
           			length--;
           			if(length==0){break;}
           		}
           		var type=(types[length]=='addType' || types[length]=='norm')?0:types[length];
           		var body1=$('.note-editable').html();
           		
           		//return;
           		$.ajax({
					url: 'http://localhost/index.php?app=user&act=article',
					type: 'POST',
					data: {title:titile1,typeId:type,body:body1},
					success: function(result) {
						if(result && result.retval!=false){
							
							$('#success').modal('show');
						}else{
						$('#faild').modal('show');
        			return false;
						}
						}
					});
            }
       </script>
       
         <!-- Form Related -->
       <script src="js/select.min.js"></script> <!--  Custom Select -->
        <script src="js/icheck.js"></script> <!-- Custom Checkbox + Radio -->
        
    </body>
</html>

